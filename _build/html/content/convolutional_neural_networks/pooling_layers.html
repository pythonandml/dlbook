
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>3.2.4. Pooling layers &#8212; Oddly Satisfying Deep Learning</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="shortcut icon" href="../../_static/logo.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="3.3. Convolutional Neural Networks from scratch in Python" href="cnn_from_scratch.html" />
    <link rel="prev" title="3.2.3 Backward Propagation Convolution layer (Vectorized)" href="backpropagation_convolution.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Oddly Satisfying Deep Learning</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  1. Preliminaries
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../preliminaries/data_preprocessing.html">
   1.1. Data Preprocessing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../preliminaries/performance_metrics.html">
   1.2. Performance Metrics for ML and DL models
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  2. Multilayer Perceptrons
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../multilayer_perceptrons/activation.html">
   2.1. Activation Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multilayer_perceptrons/perceptron.html">
   2.2. Perceptron
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multilayer_perceptrons/terminologies_part_1.html">
   2.3. Terminologies Part-1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multilayer_perceptrons/cost_functions.html">
   2.4. Cost functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multilayer_perceptrons/forward_propagation.html">
   2.5. Forward propagation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multilayer_perceptrons/backpropagation.html">
   2.6. Back Propagation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multilayer_perceptrons/terminologies_part_2.html">
   2.7. Terminologies Part-2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multilayer_perceptrons/gradient_descent.html">
   2.8. Gradient Descent
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multilayer_perceptrons/regularization.html">
   2.9. Regularization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multilayer_perceptrons/dropout.html">
   2.10. Dropout regularization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multilayer_perceptrons/batch_normalization.html">
   2.11. Batch Normalization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multilayer_perceptrons/numerical_example_forward_backward_propagation.html">
   2.12. Numerical example Forward and Back pass
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multilayer_perceptrons/shortcut_to_calculate_forward_back_propagation.html">
   2.13. Shortcut to calculate forward pass and backpropagation across layers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multilayer_perceptrons/neural_networks_mlp_scratch_best.html">
   2.14. MLP model from scratch in Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multilayer_perceptrons/mlp_pytorch.html">
   2.15. 4 step process to build MLP model using PyTorch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multilayer_perceptrons/mlp_keras.html">
   2.16. MLP model using Tensorflow - Keras
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  3. Convolutional Neural Networks
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="cnn_over_mlp.html">
   3.1. Convolutional Neural Networks over MLP
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="cnn_architecture.html">
   3.2. Basic Architecture of CNN
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="convolutional_layers.html">
     3.2.1. Convolutional layers
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="forward_propagation_convolution.html">
     3.2.2 Forward Propagation Convolution layer (Vectorized)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="backpropagation_convolution.html">
     3.2.3 Backward Propagation Convolution layer (Vectorized)
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     3.2.4. Pooling layers
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cnn_from_scratch.html">
   3.3. Convolutional Neural Networks from scratch in Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cnn_pytorch.html">
   3.4. 4 step process to build a CNN model using PyTorch
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cnn_keras.html">
   3.5. CNN model using Tensorflow - Keras
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cnn_state_of_the_art.html">
   3.6. State of the art CNN models
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  4. Word Embeddings
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../word_embeddings/traditional_word_embeddings.html">
   4.1. Traditional Word Embeddings
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../word_embeddings/static_word_embeddings.html">
   4.2. Static Word Embeddings
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../word_embeddings/word2vec.html">
     4.2.1. Word2Vec
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../word_embeddings/glove.html">
     4.2.2 GloVe
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../word_embeddings/fasttext.html">
     4.2.3. FastText
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../word_embeddings/contextual_word_embeddings.html">
   4.3. Contextual Word Embeddings
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../word_embeddings/elmo.html">
     4.3.1. Embeddings from Language Models (ELMo)
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/pythonandml/dlbook/master?urlpath=tree/content/convolutional_neural_networks/pooling_layers.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/pythonandml/dlbook/blob/master/content/convolutional_neural_networks/pooling_layers.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/pythonandml/dlbook"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/pythonandml/dlbook/issues/new?title=Issue%20on%20page%20%2Fcontent/convolutional_neural_networks/pooling_layers.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/content/convolutional_neural_networks/pooling_layers.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#how-does-pooling-work">
   How does Pooling work?
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#max-pooling">
     Max Pooling
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#average-pooling">
     Average Pooling
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#forward-propagation-for-pooling-layer">
   Forward Propagation for Pooling layer
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#simple-input-no-channels-and-batch">
     Simple Input (no channels and batch)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#input-with-batch-of-images-with-channels">
     Input with batch of images (with channels)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#back-propagation-for-pooling-layer">
   Back Propagation for Pooling layer
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#maxpool">
     Maxpool
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#average-pool">
     Average pool
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>3.2.4. Pooling layers</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#how-does-pooling-work">
   How does Pooling work?
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#max-pooling">
     Max Pooling
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#average-pooling">
     Average Pooling
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#forward-propagation-for-pooling-layer">
   Forward Propagation for Pooling layer
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#simple-input-no-channels-and-batch">
     Simple Input (no channels and batch)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#input-with-batch-of-images-with-channels">
     Input with batch of images (with channels)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#back-propagation-for-pooling-layer">
   Back Propagation for Pooling layer
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#maxpool">
     Maxpool
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#average-pool">
     Average pool
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="pooling-layers">
<h1>3.2.4. Pooling layers<a class="headerlink" href="#pooling-layers" title="Permalink to this headline">#</a></h1>
<p><img alt="" src="../../_images/pooling_layer.png" /></p>
<p>A major problem with convolutional layer is that the <code class="docutils literal notranslate"><span class="pre">feature</span> <span class="pre">map</span></code> (output) produced by the convolution between input and kernel is <strong>translation variant (that is location-dependent)</strong>.</p>
<p>This means that if an object in an image has shifted a bit it might not be recognizable by the convolutional layer. So, it means that the feature map (output) records the precise positions of features in the input.</p>
<p>Therefore we want a layer which can take as input this feature map (output from convolution) and make it <strong>translation invariant (which means location of the feature should not matter)</strong>. This is done by a <code class="docutils literal notranslate"><span class="pre">pooling</span> <span class="pre">layer</span></code>.</p>
<section id="how-does-pooling-work">
<h2>How does Pooling work?<a class="headerlink" href="#how-does-pooling-work" title="Permalink to this headline">#</a></h2>
<p>We select a Kernel and slide it over the feature map (output from the preceding convolution layer after activation is applied)
and based on the type of pooling operation we’ve selected, the pooling kernel calculates an output.</p>
<p>The most commonly used Kernel size is <span class="math notranslate nohighlight">\((2,2)\)</span> along with a stride of 2.</p>
<section id="max-pooling">
<h3>Max Pooling<a class="headerlink" href="#max-pooling" title="Permalink to this headline">#</a></h3>
<p>In max pooling, the filter simply selects the maximum pixel value in the receptive field. From the below gif, we see that the kernel is selecting only the maximum value from the receptive field (like in the first slot, we have 4 pixels in the field with values 1, 5, 2, and 6, and we select 6).</p>
<p><img alt="" src="../../_images/maxpool.gif" /></p>
</section>
<section id="average-pooling">
<h3>Average Pooling<a class="headerlink" href="#average-pooling" title="Permalink to this headline">#</a></h3>
<p>In average pooling, the filter simply selects the average value of all the pixels in the receptive field.</p>
<p><img alt="" src="../../_images/averagepool.gif" /></p>
</section>
</section>
<section id="forward-propagation-for-pooling-layer">
<h2>Forward Propagation for Pooling layer<a class="headerlink" href="#forward-propagation-for-pooling-layer" title="Permalink to this headline">#</a></h2>
<p>Let us write the python code (using only numpy) to implement forward propagation in pooling layer!</p>
<section id="simple-input-no-channels-and-batch">
<h3>Simple Input (no channels and batch)<a class="headerlink" href="#simple-input-no-channels-and-batch" title="Permalink to this headline">#</a></h3>
<p>We will start with a simple Input (with no channels and batch) of shape <span class="math notranslate nohighlight">\((N_h, N_w)\)</span> and then progress further.</p>
<p><img alt="" src="../../_images/maxpool_input.png" /></p>
<p>The function <code class="docutils literal notranslate"><span class="pre">pad_input2D(X,K,s,p)</span></code> performs padding on input <span class="math notranslate nohighlight">\(X\)</span> (with no channels and batch) and returns the padded matrix.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pad_input2D</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">K_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span><span class="nb">int</span><span class="p">:</span>
        <span class="n">Nh</span><span class="p">,</span> <span class="n">Nw</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">pt</span><span class="p">,</span> <span class="n">pb</span> <span class="o">=</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span>
        <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span>
        
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span><span class="nb">tuple</span><span class="p">:</span>
        <span class="n">Nh</span><span class="p">,</span> <span class="n">Nw</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="n">ph</span><span class="p">,</span><span class="n">pw</span> <span class="o">=</span> <span class="n">p</span>
        <span class="n">pt</span><span class="p">,</span> <span class="n">pb</span> <span class="o">=</span> <span class="n">ph</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">ph</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">pw</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">pw</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        
    <span class="k">elif</span> <span class="n">p</span><span class="o">==</span><span class="s1">&#39;valid&#39;</span><span class="p">:</span>
        <span class="n">Nh</span><span class="p">,</span> <span class="n">Nw</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">pt</span><span class="p">,</span> <span class="n">pb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

    <span class="k">elif</span> <span class="n">p</span><span class="o">==</span><span class="s1">&#39;same&#39;</span><span class="p">:</span>
        <span class="n">Nh</span><span class="p">,</span> <span class="n">Nw</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">K</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Kh</span><span class="p">,</span> <span class="n">Kw</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Kh</span><span class="p">,</span> <span class="n">Kw</span> <span class="o">=</span> <span class="n">K_size</span>
        <span class="n">sh</span><span class="p">,</span> <span class="n">sw</span> <span class="o">=</span> <span class="n">s</span>

        <span class="n">ph</span> <span class="o">=</span> <span class="p">(</span><span class="n">sh</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Nh</span> <span class="o">+</span> <span class="n">Kh</span> <span class="o">-</span> <span class="n">sh</span>
        <span class="n">pw</span> <span class="o">=</span> <span class="p">(</span><span class="n">sw</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Nw</span> <span class="o">+</span> <span class="n">Kw</span> <span class="o">-</span> <span class="n">sw</span>

        <span class="n">pt</span><span class="p">,</span> <span class="n">pb</span> <span class="o">=</span> <span class="n">ph</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">ph</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">pw</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">pw</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Incorrect padding type. Allowed types are only &#39;same&#39; or &#39;valid&#39; or an integer.&quot;</span><span class="p">)</span>

    <span class="n">Xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">pt</span><span class="p">,</span> <span class="n">Nw</span><span class="p">)),</span> <span class="n">X</span><span class="p">))</span>
    <span class="n">Xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">Xp</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">pb</span><span class="p">,</span> <span class="n">Nw</span><span class="p">))))</span>
    <span class="n">Xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nh</span><span class="o">+</span><span class="n">pt</span><span class="o">+</span><span class="n">pb</span><span class="p">,</span> <span class="n">pl</span><span class="p">)),</span> <span class="n">Xp</span><span class="p">))</span>
    <span class="n">Xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Xp</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nh</span><span class="o">+</span><span class="n">pt</span><span class="o">+</span><span class="n">pb</span><span class="p">,</span> <span class="n">pr</span><span class="p">))))</span>

    <span class="k">return</span> <span class="n">Xp</span>
</pre></div>
</div>
</div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">pooling2d(X,</span> <span class="pre">pool_size,</span> <span class="pre">s,</span> <span class="pre">p,</span> <span class="pre">pool_type)</span></code> performs max/mean pooling on a 2d array using numpy.</p>
<p>So, the idea is to create a sub-matrices of the input using the given kernel size and stride (with the help of <code class="docutils literal notranslate"><span class="pre">as_stride()</span></code> of numpy) and then simply take the maximum along the height and width axes.</p>
<blockquote>
<div><p><strong>Note</strong>: The main benefit of using this method is that it can be extended for input with channels (depth) and batches as well!</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pooling2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">pool_type</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">):</span>
    
    <span class="c1"># padding</span>
    <span class="n">Xp</span> <span class="o">=</span> <span class="n">pad_input2D</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">K_size</span><span class="o">=</span><span class="n">pool_size</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Xp (padded X)&#39;</span> <span class="o">+</span> <span class="s1">&#39; for padding=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; = </span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Xp</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">Nh</span><span class="p">,</span> <span class="n">Nw</span> <span class="o">=</span> <span class="n">Xp</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sh</span><span class="p">,</span> <span class="n">sw</span> <span class="o">=</span> <span class="n">s</span> <span class="c1"># strides along height and width</span>
    <span class="n">Kh</span><span class="p">,</span> <span class="n">Kw</span> <span class="o">=</span> <span class="n">pool_size</span>

    <span class="n">Oh</span> <span class="o">=</span> <span class="p">(</span><span class="n">Nh</span><span class="o">-</span><span class="n">Kh</span><span class="p">)</span><span class="o">//</span><span class="n">sh</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">Ow</span> <span class="o">=</span> <span class="p">(</span><span class="n">Nw</span><span class="o">-</span><span class="n">Kw</span><span class="p">)</span><span class="o">//</span><span class="n">sw</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">strides</span> <span class="o">=</span> <span class="p">(</span><span class="n">sh</span><span class="o">*</span><span class="n">Nw</span><span class="p">,</span> <span class="n">sw</span><span class="p">,</span> <span class="n">Nw</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">strides</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">Xp</span><span class="o">.</span><span class="n">itemsize</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">strides</span><span class="p">)</span>

    <span class="n">subM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span><span class="n">Xp</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">Oh</span><span class="p">,</span> <span class="n">Ow</span><span class="p">,</span> <span class="n">Kh</span><span class="p">,</span> <span class="n">Kw</span><span class="p">),</span>
                                           <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pool_type</span><span class="o">==</span><span class="s1">&#39;max&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">subM</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># maximum along height and width</span>
    <span class="k">elif</span> <span class="n">pool_type</span><span class="o">==</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">subM</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Allowed pool types are only &#39;max&#39; or &#39;mean&#39;.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Try <code class="docutils literal notranslate"><span class="pre">pool_type=&quot;max&quot;</span></code></strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">11</span><span class="p">,</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">]])</span>

<span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Kernel size</span>

<span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># strides along height and width</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;X = </span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">Z</span> <span class="o">=</span> <span class="n">pooling2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">pool_type</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Z = </span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>X = 

 [[ 1  5  3 -3]
 [ 2  6 -1  1]
 [ 0  4  7  2]
 [11 -5  8  6]] 

Xp (padded X) for padding=same = 

 [[ 0.  0.  0.  0.  0.  0.  0.  0.]
 [ 0.  0.  0.  0.  0.  0.  0.  0.]
 [ 0.  0.  1.  5.  3. -3.  0.  0.]
 [ 0.  0.  2.  6. -1.  1.  0.  0.]
 [ 0.  0.  0.  4.  7.  2.  0.  0.]
 [ 0.  0. 11. -5.  8.  6.  0.  0.]
 [ 0.  0.  0.  0.  0.  0.  0.  0.]
 [ 0.  0.  0.  0.  0.  0.  0.  0.]] 

Z = 

 [[ 0.  0.  0.  0.]
 [ 0.  6.  3.  0.]
 [ 0. 11.  8.  0.]
 [ 0.  0.  0.  0.]] 
</pre></div>
</div>
</div>
</div>
<p><strong>Try <code class="docutils literal notranslate"><span class="pre">pool_type=&quot;mean&quot;</span></code></strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span>
              <span class="p">[</span><span class="mi">11</span><span class="p">,</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">7</span><span class="p">]])</span>

<span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Kernel size</span>

<span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># strides along height and width</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;X = </span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">Z</span> <span class="o">=</span> <span class="n">pooling2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">pool_type</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Z = </span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>X = 

 [[ 1  5  3 -3]
 [ 2  6 -1  1]
 [ 0  4  7  2]
 [11 -5  8  7]] 

Xp (padded X) for padding=same = 

 [[ 0.  0.  0.  0.  0.  0.  0.  0.]
 [ 0.  0.  0.  0.  0.  0.  0.  0.]
 [ 0.  0.  1.  5.  3. -3.  0.  0.]
 [ 0.  0.  2.  6. -1.  1.  0.  0.]
 [ 0.  0.  0.  4.  7.  2.  0.  0.]
 [ 0.  0. 11. -5.  8.  7.  0.  0.]
 [ 0.  0.  0.  0.  0.  0.  0.  0.]
 [ 0.  0.  0.  0.  0.  0.  0.  0.]] 

Z = 

 [[0.  0.  0.  0. ]
 [0.  3.5 0.  0. ]
 [0.  2.5 6.  0. ]
 [0.  0.  0.  0. ]] 
</pre></div>
</div>
</div>
</div>
<p>It worked like a charm! Let us now extend the same using input (with channels or depth and batches)</p>
</section>
<section id="input-with-batch-of-images-with-channels">
<h3>Input with batch of images (with channels)<a class="headerlink" href="#input-with-batch-of-images-with-channels" title="Permalink to this headline">#</a></h3>
<p><strong>Next we will also include channels to image as Input</strong></p>
<p>A batch of images (with channels) as input of shape <span class="math notranslate nohighlight">\((m, N_c, N_h, N_w)\)</span> is used.</p>
<blockquote>
<div><p><strong>Note:</strong> See how the depth of the pool is same as the number of channels (one 2D pool for each channel).</p>
</div></blockquote>
<p><img alt="" src="../../_images/input_batch_channels.png" /></p>
<p>The function <code class="docutils literal notranslate"><span class="pre">pad_input2D_with_channels_batch(X,K,s,p)</span></code> performs padding on input <span class="math notranslate nohighlight">\(X\)</span> (with channels) and returns the padded matrix.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pad_input2D_with_channels_batch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">K_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span><span class="nb">int</span><span class="p">:</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">Nh</span><span class="p">,</span> <span class="n">Nw</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">pt</span><span class="p">,</span> <span class="n">pb</span> <span class="o">=</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span>
        <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">p</span><span class="p">,</span> <span class="n">p</span>
        
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">==</span><span class="nb">tuple</span><span class="p">:</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">Nh</span><span class="p">,</span> <span class="n">Nw</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="n">ph</span><span class="p">,</span> <span class="n">pw</span> <span class="o">=</span> <span class="n">p</span>
        <span class="n">pt</span><span class="p">,</span> <span class="n">pb</span> <span class="o">=</span> <span class="n">ph</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">ph</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">pw</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">pw</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
    
    <span class="k">elif</span> <span class="n">p</span><span class="o">==</span><span class="s1">&#39;valid&#39;</span><span class="p">:</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">Nh</span><span class="p">,</span> <span class="n">Nw</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">pt</span><span class="p">,</span> <span class="n">pb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    
    <span class="k">elif</span> <span class="n">p</span><span class="o">==</span><span class="s1">&#39;same&#39;</span><span class="p">:</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">Nh</span><span class="p">,</span> <span class="n">Nw</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="k">if</span> <span class="n">K</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Kc</span><span class="p">,</span> <span class="n">Kh</span><span class="p">,</span> <span class="n">Kw</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Kh</span><span class="p">,</span> <span class="n">Kw</span> <span class="o">=</span> <span class="n">K_size</span>
            
        <span class="n">sh</span><span class="p">,</span> <span class="n">sw</span> <span class="o">=</span> <span class="n">s</span>

        <span class="n">ph</span> <span class="o">=</span> <span class="p">(</span><span class="n">sh</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Nh</span> <span class="o">+</span> <span class="n">Kh</span> <span class="o">-</span> <span class="n">sh</span>
        <span class="n">pw</span> <span class="o">=</span> <span class="p">(</span><span class="n">sw</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Nw</span> <span class="o">+</span> <span class="n">Kw</span> <span class="o">-</span> <span class="n">sw</span>

        <span class="n">pt</span><span class="p">,</span> <span class="n">pb</span> <span class="o">=</span> <span class="n">ph</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">ph</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">pw</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">pw</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Incorrect padding type. Allowed types are only &#39;same&#39; or &#39;valid&#39;.&quot;</span><span class="p">)</span>

    <span class="n">zeros_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">Nh</span><span class="p">,</span> <span class="n">pr</span><span class="p">))</span>
    <span class="n">zeros_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">Nh</span><span class="p">,</span> <span class="n">pl</span><span class="p">))</span>
    <span class="n">zeros_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">Nw</span><span class="o">+</span><span class="n">pl</span><span class="o">+</span><span class="n">pr</span><span class="p">))</span>
    <span class="n">zeros_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">pb</span><span class="p">,</span> <span class="n">Nw</span><span class="o">+</span><span class="n">pl</span><span class="o">+</span><span class="n">pr</span><span class="p">))</span>

    <span class="n">Xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">X</span><span class="p">,</span> <span class="n">zeros_r</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">Xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">zeros_l</span><span class="p">,</span> <span class="n">Xp</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">Xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">zeros_t</span><span class="p">,</span> <span class="n">Xp</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">Xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Xp</span><span class="p">,</span> <span class="n">zeros_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Xp</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pooling2d_with_channels_batch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">,</span> <span class="n">pool_type</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">):</span>
    
    <span class="c1"># padding</span>
    <span class="n">Xp</span> <span class="o">=</span> <span class="n">pad_input2D_with_channels_batch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">K_size</span><span class="o">=</span><span class="n">pool_size</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Xp (padded X)&#39;</span> <span class="o">+</span> <span class="s1">&#39; for padding=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; = </span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Xp</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">m</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">Nh</span><span class="p">,</span> <span class="n">Nw</span> <span class="o">=</span> <span class="n">Xp</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sh</span><span class="p">,</span> <span class="n">sw</span> <span class="o">=</span> <span class="n">s</span> <span class="c1"># strides along height and width</span>
    <span class="n">Kh</span><span class="p">,</span> <span class="n">Kw</span> <span class="o">=</span> <span class="n">pool_size</span>

    <span class="n">Oh</span> <span class="o">=</span> <span class="p">(</span><span class="n">Nh</span><span class="o">-</span><span class="n">Kh</span><span class="p">)</span><span class="o">//</span><span class="n">sh</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">Ow</span> <span class="o">=</span> <span class="p">(</span><span class="n">Nw</span><span class="o">-</span><span class="n">Kw</span><span class="p">)</span><span class="o">//</span><span class="n">sw</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">strides</span> <span class="o">=</span> <span class="p">(</span><span class="n">Nc</span><span class="o">*</span><span class="n">Nh</span><span class="o">*</span><span class="n">Nw</span><span class="p">,</span> <span class="n">Nh</span><span class="o">*</span><span class="n">Nw</span><span class="p">,</span> <span class="n">Nw</span><span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="n">sw</span><span class="p">,</span> <span class="n">Nw</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">strides</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">Xp</span><span class="o">.</span><span class="n">itemsize</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">strides</span><span class="p">)</span>

    <span class="n">subM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span><span class="n">Xp</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">Oh</span><span class="p">,</span> <span class="n">Ow</span><span class="p">,</span> <span class="n">Kh</span><span class="p">,</span> <span class="n">Kw</span><span class="p">),</span>
                                            <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">)</span>
    
    <span class="n">a</span> <span class="o">=</span> <span class="n">subM</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">Kh</span><span class="o">*</span><span class="n">Kw</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">b</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">Oh</span><span class="p">,</span> <span class="n">Ow</span><span class="p">,</span> <span class="n">Kh</span><span class="p">,</span> <span class="n">Kw</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">pool_type</span><span class="o">==</span><span class="s1">&#39;max&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">subM</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mask</span><span class="p">,</span> <span class="n">Xp</span> <span class="c1"># maximum along height and width of submatrix</span>
    <span class="k">elif</span> <span class="n">pool_type</span><span class="o">==</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">subM</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mask</span><span class="p">,</span> <span class="n">Xp</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Allowed pool types are only &#39;max&#39; or &#39;mean&#39;.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Try <code class="docutils literal notranslate"><span class="pre">pool_type=&quot;max&quot;</span></code></strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

<span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Kernel size</span>

<span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># strides along height and width</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;X = </span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">Z</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">Xp</span> <span class="o">=</span> <span class="n">pooling2d_with_channels_batch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">pool_type</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Z = </span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>X = 

 [[[[9 4 0]
   [1 9 0]
   [1 8 9]]

  [[0 8 6]
   [4 3 0]
   [4 6 8]]]


 [[[1 8 4]
   [1 3 6]
   [5 3 9]]

  [[6 9 1]
   [9 4 2]
   [6 7 8]]]] 

Xp (padded X) for padding=same = 

 [[[[0. 9. 4. 0. 0. 0.]
   [0. 1. 9. 0. 0. 0.]
   [0. 1. 8. 9. 0. 0.]
   [0. 0. 0. 0. 0. 0.]]

  [[0. 0. 8. 6. 0. 0.]
   [0. 4. 3. 0. 0. 0.]
   [0. 4. 6. 8. 0. 0.]
   [0. 0. 0. 0. 0. 0.]]]


 [[[0. 1. 8. 4. 0. 0.]
   [0. 1. 3. 6. 0. 0.]
   [0. 5. 3. 9. 0. 0.]
   [0. 0. 0. 0. 0. 0.]]

  [[0. 6. 9. 1. 0. 0.]
   [0. 9. 4. 2. 0. 0.]
   [0. 6. 7. 8. 0. 0.]
   [0. 0. 0. 0. 0. 0.]]]] 

Z = 

 [[[[9. 9. 0.]
   [1. 9. 0.]
   [1. 9. 0.]]

  [[4. 8. 0.]
   [4. 8. 0.]
   [4. 8. 0.]]]


 [[[1. 8. 0.]
   [5. 9. 0.]
   [5. 9. 0.]]

  [[9. 9. 0.]
   [9. 8. 0.]
   [6. 8. 0.]]]] 
</pre></div>
</div>
</div>
</div>
<p><strong>Try <code class="docutils literal notranslate"><span class="pre">pool_type=&quot;mean&quot;</span></code></strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

<span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Kernel size</span>

<span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># strides along height and width</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;X = </span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">Z</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">Xp</span> <span class="o">=</span> <span class="n">pooling2d_with_channels_batch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">pool_type</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Z = </span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>X = 

 [[[[9 4 0]
   [1 9 0]
   [1 8 9]]

  [[0 8 6]
   [4 3 0]
   [4 6 8]]]


 [[[1 8 4]
   [1 3 6]
   [5 3 9]]

  [[6 9 1]
   [9 4 2]
   [6 7 8]]]] 

Xp (padded X) for padding=same = 

 [[[[0. 9. 4. 0. 0. 0.]
   [0. 1. 9. 0. 0. 0.]
   [0. 1. 8. 9. 0. 0.]
   [0. 0. 0. 0. 0. 0.]]

  [[0. 0. 8. 6. 0. 0.]
   [0. 4. 3. 0. 0. 0.]
   [0. 4. 6. 8. 0. 0.]
   [0. 0. 0. 0. 0. 0.]]]


 [[[0. 1. 8. 4. 0. 0.]
   [0. 1. 3. 6. 0. 0.]
   [0. 5. 3. 9. 0. 0.]
   [0. 0. 0. 0. 0. 0.]]

  [[0. 6. 9. 1. 0. 0.]
   [0. 9. 4. 2. 0. 0.]
   [0. 6. 7. 8. 0. 0.]
   [0. 0. 0. 0. 0. 0.]]]] 

Z = 

 [[[[2.5  3.25 0.  ]
   [0.5  6.5  0.  ]
   [0.25 4.25 0.  ]]

  [[1.   4.25 0.  ]
   [2.   4.25 0.  ]
   [1.   3.5  0.  ]]]


 [[[0.5  5.25 0.  ]
   [1.5  5.25 0.  ]
   [1.25 3.   0.  ]]

  [[3.75 4.   0.  ]
   [3.75 5.25 0.  ]
   [1.5  3.75 0.  ]]]] 
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="back-propagation-for-pooling-layer">
<h2>Back Propagation for Pooling layer<a class="headerlink" href="#back-propagation-for-pooling-layer" title="Permalink to this headline">#</a></h2>
<p>Now let us write the python code (using only numpy) to implement backpropagation in the pooling layer!</p>
<section id="maxpool">
<h3>Maxpool<a class="headerlink" href="#maxpool" title="Permalink to this headline">#</a></h3>
<p>Suppose we have the following maxpool operation (forward) where the shaded pixels (in red) represents the maximum value of that receptive field.</p>
<p><img alt="" src="../../_images/maxpool_2d.png" /></p>
<p>Now, let the output error that we receive into this maxpool system be <span class="math notranslate nohighlight">\(dZ\)</span> such that:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
dZ = \begin{bmatrix}
dZ_{1} &amp; dZ_{2} \\ 
dZ_{3} &amp; dZ_{4}
\end{bmatrix}
\end{split}\]</div>
<blockquote>
<div><p>The gradient of the error <span class="math notranslate nohighlight">\(dX\)</span> with respect to the input features is nonzero only if the input feature has the maximum value in the pooling kernel.</p>
</div></blockquote>
<p>Using this strategy, we can compute the full backward pass (to compute <span class="math notranslate nohighlight">\(dX\)</span>) as follows:</p>
<p><img alt="" src="../../_images/maxpool_backpass.png" /></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># padding</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

<span class="n">pool_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Kernel size</span>

<span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># strides along height and width</span>

<span class="n">Z</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">Xp</span> <span class="o">=</span> <span class="n">pooling2d_with_channels_batch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">pool_type</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Xp (padded X) for padding=same = 

 [[[[0. 9. 4. 0. 0. 0.]
   [0. 1. 9. 0. 0. 0.]
   [0. 1. 8. 9. 0. 0.]
   [0. 0. 0. 0. 0. 0.]]

  [[0. 0. 8. 6. 0. 0.]
   [0. 4. 3. 0. 0. 0.]
   [0. 4. 6. 8. 0. 0.]
   [0. 0. 0. 0. 0. 0.]]]


 [[[0. 1. 8. 4. 0. 0.]
   [0. 1. 3. 6. 0. 0.]
   [0. 5. 3. 9. 0. 0.]
   [0. 0. 0. 0. 0. 0.]]

  [[0. 6. 9. 1. 0. 0.]
   [0. 9. 4. 2. 0. 0.]
   [0. 6. 7. 8. 0. 0.]
   [0. 0. 0. 0. 0. 0.]]]] 
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">pooling2d_backwards_with_channels_batch(dZ,</span> <span class="pre">mask,</span> <span class="pre">X,</span> <span class="pre">pool_size)</span></code> function implements the backpropagation in the maxpooling layer!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pooling2d_max_backwards_with_channels_batch</span><span class="p">(</span><span class="n">dZ</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">):</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">Nh</span><span class="p">,</span> <span class="n">Nw</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">Kh</span><span class="p">,</span> <span class="n">Kw</span> <span class="o">=</span> <span class="n">pool_size</span>
    <span class="n">dA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,ijk-&gt;ijk&#39;</span><span class="p">,</span> <span class="n">dZ</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">mask</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">Kh</span><span class="p">,</span><span class="n">Kw</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">strides</span> <span class="o">=</span> <span class="p">(</span><span class="n">Nc</span><span class="o">*</span><span class="n">Nh</span><span class="o">*</span><span class="n">Nw</span><span class="p">,</span> <span class="n">Nh</span><span class="o">*</span><span class="n">Nw</span><span class="p">,</span> <span class="n">Nw</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">strides</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">X</span><span class="o">.</span><span class="n">itemsize</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">strides</span><span class="p">)</span>
    <span class="n">dX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span><span class="n">dA</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">strides</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dX</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">dZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> 

<span class="n">dXp</span> <span class="o">=</span> <span class="n">pooling2d_max_backwards_with_channels_batch</span><span class="p">(</span><span class="n">dZ</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">Xp</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">)</span>

<span class="n">dXp</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[[[  0.,  -1.,   0.,   0.,   0.,   0.],
         [ -6.,   0.,   5.,   0.,   0.,   0.],
         [  0., -10.,   0.,   0.,   7.,   0.],
         [  0.,   0.,   6.,   0.,   0.,   0.]],

        [[  0.,   7.,   0.,   0.,   0.,  -2.],
         [  0.,   0.,  -1.,   0.,   0.,   0.],
         [  0.,   0.,   0., -10.,   0.,   0.],
         [  0.,   0.,  -2.,   0.,   0.,   0.]]],


       [[[  0.,  -6.,   0.,   0.,   0.,   0.],
         [  0.,   9.,   6.,   0.,   0.,   0.],
         [  0.,  -6.,   0.,   0.,   0.,   5.],
         [  0.,   0.,   1.,   0.,   0.,   0.]],

        [[  0.,   1.,   0.,   0.,  -9.,   0.],
         [  0.,   0.,  -2.,   0.,   0.,   0.],
         [  0.,   0.,   0.,  -6.,   0.,   0.],
         [  0.,   4.,   7.,   0.,   0.,   0.]]]])
</pre></div>
</div>
</div>
</div>
<p>We need a small function such that we can extract the original input errors from the padding ones. This you can consider as <strong>backpropagation through padding operation</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">padding2D_backwards_with_channels_batch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Xp</span><span class="p">,</span> <span class="n">dXp</span><span class="p">):</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">Nh</span><span class="p">,</span> <span class="n">Nw</span> <span class="o">=</span> <span class="n">Xp</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">Nhx</span><span class="p">,</span> <span class="n">Nwx</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="n">Nh</span> <span class="o">-</span> <span class="n">Nhx</span>
    <span class="n">pw</span> <span class="o">=</span> <span class="n">Nw</span> <span class="o">-</span> <span class="n">Nwx</span>
    <span class="n">pt</span><span class="p">,</span> <span class="n">pb</span> <span class="o">=</span> <span class="n">ph</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">ph</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
    <span class="n">pl</span><span class="p">,</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">pw</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">pw</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
    <span class="n">dX</span> <span class="o">=</span> <span class="n">dXp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">pt</span><span class="p">:</span><span class="n">pt</span><span class="o">+</span><span class="n">Nhx</span><span class="p">,</span> <span class="n">pl</span><span class="p">:</span><span class="n">pl</span><span class="o">+</span><span class="n">Nwx</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dX</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dX</span> <span class="o">=</span> <span class="n">padding2D_backwards_with_channels_batch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Xp</span><span class="p">,</span> <span class="n">dXp</span><span class="p">)</span>
<span class="n">dX</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[[[ -1.,   0.,   0.],
         [  0.,   5.,   0.],
         [-10.,   0.,   0.]],

        [[  7.,   0.,   0.],
         [  0.,  -1.,   0.],
         [  0.,   0., -10.]]],


       [[[ -6.,   0.,   0.],
         [  9.,   6.,   0.],
         [ -6.,   0.,   0.]],

        [[  1.,   0.,   0.],
         [  0.,  -2.,   0.],
         [  0.,   0.,  -6.]]]])
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><p>Congrats! We have successfully calculated the gradients of the input <span class="math notranslate nohighlight">\(dX\)</span> for the maxpooling layer using only numpy (and no for loops)!</p>
</div></blockquote>
</section>
<section id="average-pool">
<h3>Average pool<a class="headerlink" href="#average-pool" title="Permalink to this headline">#</a></h3>
<p>Now we will be writing the code for computing the gradient in case of average pooling. This code is also written using numpy and it is the most generalized code which runs without for loops and you will hardly find it anywhere on net!</p>
<p>I will not be going with the theoretical explaination but if you are interested you can visit <a class="reference external" href="https://lanstonchu.wordpress.com/2018/09/01/convolutional-neural-network-cnn-backward-propagation-of-the-pooling-layers/">this site</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pooling2d_avg_backwards_with_channels_batch</span><span class="p">(</span><span class="n">dZ</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">):</span>
    
    <span class="n">m</span><span class="p">,</span> <span class="n">Nc</span><span class="p">,</span> <span class="n">Nh</span><span class="p">,</span> <span class="n">Nw</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">sh</span><span class="p">,</span> <span class="n">sw</span> <span class="o">=</span> <span class="n">s</span>
    <span class="n">Kh</span><span class="p">,</span> <span class="n">Kw</span> <span class="o">=</span> <span class="n">pool_size</span>
    
    <span class="n">dZp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">dZ</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Kh</span><span class="p">,</span><span class="n">Kw</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dZ</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span> <span class="c1"># similar to repelem in matlab</span>

    <span class="n">jh</span><span class="p">,</span> <span class="n">jw</span> <span class="o">=</span> <span class="n">Kh</span><span class="o">-</span><span class="n">sh</span><span class="p">,</span> <span class="n">Kw</span><span class="o">-</span><span class="n">sw</span> <span class="c1"># jump along height and width</span>

    <span class="k">if</span> <span class="n">jw</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">dZp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>

        <span class="n">l1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sw</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
        <span class="n">l2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sw</span> <span class="o">+</span> <span class="n">jw</span><span class="p">,</span> <span class="n">L</span> <span class="o">+</span> <span class="n">jw</span><span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span><span class="o">*</span><span class="n">jw</span> <span class="o">+</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span><span class="o">*</span><span class="n">jw</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span><span class="o">//</span><span class="n">jw</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

        <span class="n">r1</span> <span class="o">=</span> <span class="n">l1</span><span class="p">[</span><span class="n">mask</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">l1</span><span class="p">)]]</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">l2</span><span class="p">[</span><span class="n">mask</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">l2</span><span class="p">)]]</span>

        <span class="n">dZp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">r1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dZp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">r2</span><span class="p">]</span>
        <span class="n">dZp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">dZp</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">jh</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">dZp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>

        <span class="n">l1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
        <span class="n">l2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sh</span> <span class="o">+</span> <span class="n">jh</span><span class="p">,</span> <span class="n">L</span> <span class="o">+</span> <span class="n">jh</span><span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span><span class="o">*</span><span class="n">jh</span> <span class="o">+</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span><span class="o">*</span><span class="n">jh</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span><span class="o">//</span><span class="n">jh</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

        <span class="n">r1</span> <span class="o">=</span> <span class="n">l1</span><span class="p">[</span><span class="n">mask</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">l1</span><span class="p">)]]</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">l2</span><span class="p">[</span><span class="n">mask</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">l2</span><span class="p">)]]</span>

        <span class="n">dZp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">r1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">dZp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">r2</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dZp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">dZp</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">pw</span> <span class="o">=</span> <span class="n">Nw</span> <span class="o">-</span> <span class="n">dZp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ph</span> <span class="o">=</span> <span class="n">Nh</span> <span class="o">-</span> <span class="n">dZp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">dXp</span> <span class="o">=</span> <span class="n">pad_input2D_with_channels_batch</span><span class="p">(</span><span class="n">dZp</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="p">(</span><span class="n">ph</span><span class="p">,</span> <span class="n">pw</span><span class="p">),</span> <span class="n">K_size</span><span class="o">=</span><span class="n">pool_size</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dXp</span> <span class="o">/</span> <span class="p">(</span><span class="n">Nh</span><span class="o">*</span><span class="n">Nw</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="n">dZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> 

<span class="n">dXp</span> <span class="o">=</span> <span class="n">pooling2d_avg_backwards_with_channels_batch</span><span class="p">(</span><span class="n">dZ</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Xp</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">)</span>

<span class="n">dXp</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2, 2, 4, 6)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dX</span> <span class="o">=</span> <span class="n">padding2D_backwards_with_channels_batch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Xp</span><span class="p">,</span> <span class="n">dXp</span><span class="p">)</span>
<span class="n">dX</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[[[-0.04166667, -0.25      , -0.25      ],
         [-0.45833333,  0.04166667,  0.04166667],
         [-0.125     ,  0.20833333,  0.20833333]],

        [[-0.41666667,  0.        ,  0.        ],
         [-0.66666667,  0.375     ,  0.375     ],
         [-0.5       ,  0.58333333,  0.58333333]]],


       [[[ 0.04166667, -0.375     , -0.375     ],
         [-0.20833333, -0.20833333, -0.20833333],
         [ 0.125     ,  0.29166667,  0.29166667]],

        [[ 0.125     ,  0.375     ,  0.375     ],
         [ 0.20833333,  0.        ,  0.        ],
         [ 0.41666667, -0.25      , -0.25      ]]]])
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./content/convolutional_neural_networks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="backpropagation_convolution.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">3.2.3 Backward Propagation Convolution layer (Vectorized)</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="cnn_from_scratch.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">3.3. Convolutional Neural Networks from scratch in Python</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Ujjwal Khandelwal<br/>
  
      &copy; Copyright 2023.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>